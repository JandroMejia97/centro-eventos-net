@page "/eventos"
@rendermode InteractiveServer
@layout MainLayout

@inject EventoDeportivoObtenerTodosUseCase ObtenerEventos
@inject AuthenticationStateProvider AuthProvider
@inject EventoDeportivoEliminarUseCase EliminarEventoUseCase

<ListLayout 
    TItem="EventoDeportivo" 
    @ref="VistaDeListaDeEventos"
    Titulo="Eventos Deportivos"
    NombreDeEntidades="Eventos Deportivos"
    NombreDeEntidad="Evento Deportivo"
    RutaCrearNuevo="/eventos/agregar" 
    TextoCrearNuevo="Crear Nuevo Evento"
    CargaDeDatosDelegado="@CargarEventos"
    EliminarDatoDelegado="@EliminarEvento"
    ExtraerNombreDelDato="@ObtenerNombreDelEvento">
    <CabeceraDeTabla>
        <th>Nombre</th>
        <th>Descripción</th>
        <th>Fecha y Hora</th>
        <th>Duración (h)</th>
        <th>Cupo Máximo</th>
        <th>Responsable</th>
        <th>Estado</th>
        <th style="width: 200px;">Acciones</th> 
    </CabeceraDeTabla>
    <VistaMovil Context="currentEvento">
        <EventoDeportivoTarjeta 
            Dato="currentEvento"
            SolicitarVisualizacion="VistaDeListaDeEventos.MostrarDetallesDeDato"
            SolicitarEliminacion="VistaDeListaDeEventos.MostrarConfirmacionDeEliminacion"
        />
    </VistaMovil>
    <FilaDeTabla Context="currentEvento">
        <EventoDeportivoFila
            Dato="currentEvento"
            SolicitarVisualizacion="VistaDeListaDeEventos.MostrarDetallesDeDato"
            SolicitarEliminacion="VistaDeListaDeEventos.MostrarConfirmacionDeEliminacion"
        />
    </FilaDeTabla>
</ListLayout>

@code {
    private ListLayout<EventoDeportivo> VistaDeListaDeEventos = null!;
    private int UsuarioId = 0;

    protected IEnumerable<EventoDeportivo> CargarEventos()
    {
        var customAuthenticationStateProvider = (CustomAuthStateProvider)AuthProvider;
        UsuarioId = customAuthenticationStateProvider.ExtractUserId();
        return ObtenerEventos.Ejecutar(UsuarioId);
    }

    private void EliminarEvento(EventoDeportivo EventoAEliminar)
    {
        if (EventoAEliminar == null) return;
        EliminarEventoUseCase.Ejecutar(UsuarioId, EventoAEliminar.Id);
        if (VistaDeListaDeEventos.Datos == null) return;
        VistaDeListaDeEventos.Datos = VistaDeListaDeEventos.Datos.Where(e => e.Id != EventoAEliminar.Id);
    }

    private string ObtenerNombreDelEvento(EventoDeportivo dato) => dato.Nombre;
}