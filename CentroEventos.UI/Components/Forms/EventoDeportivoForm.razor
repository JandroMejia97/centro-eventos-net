@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms

@inject EventoDeportivoObtenerPorIdUseCase ObtenerPorIdUseCase
@inject UsuarioObtenerTodosUseCase ObtenerUsuariosUseCase

<EditForm Model="EventoDeportivo" OnValidSubmit="@HandleValidSubmit">
    <DataAnnotationsValidator />

    <div class="mb-3">
        <label class="form-label">Nombre</label>
        <InputText class="form-control" @bind-Value="EventoDeportivo.Nombre" />
        <ValidationMessage For="@(() => EventoDeportivo.Nombre)" />
    </div>

    <div class="mb-3">
        <label class="form-label">Descripción</label>
        <InputText class="form-control" @bind-Value="EventoDeportivo.Descripcion" />
        <ValidationMessage For="@(() => EventoDeportivo.Descripcion)" />
    </div>

    <div class="mb-3">
        <label class="form-label">Duración (horas)</label>
        <InputNumber TValue="double" class="form-control" @bind-Value="EventoDeportivo.DuracionHoras" />
        <ValidationMessage For="@(() => EventoDeportivo.DuracionHoras)" />
    </div>

    <div class="mb-3">
        <label class="form-label">Fecha y hora de inicio</label>
        <InputDate Type="InputDateType.DateTimeLocal" class="form-control" @bind-Value="EventoDeportivo.FechaHoraInicio" EnableMinMax="true" Min="@MinFecha" />
        <ValidationMessage For="@(() => EventoDeportivo.FechaHoraInicio)" />
    </div>

    <div class="mb-3">
        <label class="form-label">Cupo máximo</label>
        <InputNumber TValue="int" class="form-control" @bind-Value="EventoDeportivo.CupoMaximo" />
        <ValidationMessage For="@(() => EventoDeportivo.CupoMaximo)" />
    </div>

    <div class="mb-3">
        <label class="form-label">Responsable</label>
        <InputSelect
            id="responsable"
            class="form-select"
            @bind-Value="EventoDeportivo.ResponsableId"
            @disabled="@(Responsables == null || !Responsables.Any())"
        >
            <option value="">Seleccione un responsable</option>
            @foreach (var usuario in Responsables)
            {
                <option value="@usuario.PersonaId">@usuario.Persona.NombreCompleto</option>
            }
        </InputSelect>
        <ValidationMessage For="@(() => EventoDeportivo.ResponsableId)" />
    </div>

    <button type="submit" class="btn btn-primary w-100">Guardar Evento</button>

    @if (!string.IsNullOrEmpty(Error))
    {
        <div class="alert alert-danger mt-3">@Error</div>
    }
    @if (!string.IsNullOrEmpty(Mensaje))
    {
        <div class="alert alert-success mt-3">@Mensaje</div>
    }
</EditForm>
@code {
    [Parameter] public int Id { get; set; }
    [Parameter] public EventoDeportivoDto EventoDeportivo { get; set; } = new();
    [Parameter] public EventCallback<EventoDeportivo> OnSubmitCallback { get; set; } = default!;
    [Parameter] public string? Error { get; set; } = null;
    [Parameter] public string? Mensaje { get; set; } = null;
    private IEnumerable<Usuario> Responsables = Enumerable.Empty<Usuario>();
    private DateTime MinFecha = DateTime.Now;

    protected override void OnInitialized()
    {
        Responsables = ObtenerUsuariosUseCase.Ejecutar();
        if (Responsables.Count() == 1) {
            EventoDeportivo.ResponsableId = Responsables.First().PersonaId;
        }

        if (Id > 0)
        {
            try
            {
                EventoDeportivo EventoDeportivoGuardado = ObtenerPorIdUseCase.Ejecutar(Id);
                EventoDeportivo = new EventoDeportivoDto
                {
                    Nombre = EventoDeportivoGuardado.Nombre,
                    Descripcion = EventoDeportivoGuardado.Descripcion,
                    DuracionHoras = EventoDeportivoGuardado.DuracionHoras,
                    FechaHoraInicio = EventoDeportivoGuardado.FechaHoraInicio,
                    CupoMaximo = EventoDeportivoGuardado.CupoMaximo,
                    ResponsableId = EventoDeportivoGuardado.ResponsableId
                };
            }
            catch (Exception ex)
            {
                Error = $"Error al obtener el evento: {ex.Message}";
            }
        }
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            if (EventoDeportivo.FechaHoraInicio < DateTime.Now)
            {
                Error = "La fecha y hora de inicio no puede ser en el pasado.";
                Mensaje = null;
                return;
            }

            var evento = new EventoDeportivo(
                EventoDeportivo.Nombre,
                EventoDeportivo.Descripcion,
                EventoDeportivo.FechaHoraInicio,
                EventoDeportivo.DuracionHoras,
                EventoDeportivo.CupoMaximo,
                EventoDeportivo.ResponsableId
            );

            await OnSubmitCallback.InvokeAsync(evento);
        }
        catch (Exception ex)
        {
            Error = ex.Message;
            Mensaje = null;
        }
    }

    public class EventoDeportivoDto
    {
        [Required(ErrorMessage = "El nombre es obligatorio.")]
        public string Nombre { get; set; } = string.Empty;

        [Required(ErrorMessage = "La descripción es obligatoria.")]
        public string Descripcion { get; set; } = string.Empty;

        [Required(ErrorMessage = "Duración obligatoria.")]
        [Range(1, 100, ErrorMessage = "Debe ser entre 1 y 100 horas.")]
        public double DuracionHoras { get; set; }

        [Required(ErrorMessage = "Fecha y hora de inicio son obligatorias.")]
        public DateTime FechaHoraInicio { get; set; } = DateTime.Now;

        [Required(ErrorMessage = "El cupo es obligatorio.")]
        [Range(1, 9999, ErrorMessage = "El cupo debe ser un número entre 1 y 9999.")]
        public int CupoMaximo { get; set; }

        [Required(ErrorMessage = "Responsable obligatorio.")]
        [Range(1, int.MaxValue, ErrorMessage = "Debe seleccionar un responsable válido.")]
        public int ResponsableId { get; set; }
    }
}
